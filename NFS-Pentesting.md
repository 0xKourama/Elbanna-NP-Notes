# Installation/configuration
```bash
apt install nfs-kernel-server
```
## view enabled NFS version
```bash
cat /proc/fs/nfsd/versions
```
## nfs config files
```
/etc/default/nfs-kernel-server
/etc/default/nfs-common
/etc/exports
```
## sample exports config
```
# ro = read only
# rw = read + write
# crossmnt = used when sharing sub-directories (backup and www in our case) of an exported directory (nfs4)
# fsid=0 defines the NFS root directory
# sync = tells NSFS to write changes to the disk before replying
/srv/nfs4         20.20.20.0/24(rw,sync,no_subtree_check,crossmnt,fsid=0)
/srv/nfs4/backups 20.20.20.0/24(ro,sync,no_subtree_check) 20.20.20.129(rw,sync,no_subtree_check)
/srv/nfs4/www     20.20.20.133(rw,sync,no_subtree_check)
```
## after configuring the `/etc/exports`, we save it and export the shares
```bash
exportfs -ar
```
## view the currently exported shares and their state
```bash
exportfs -v
```
Output for the above configuration:
```
/srv/nfs4/backups
                20.20.20.129(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,root_squash,no_all_squash)
/srv/nfs4/www   20.20.20.133(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,root_squash,no_all_squash)
/srv/nfs4       20.20.20.0/24(sync,wdelay,hide,crossmnt,no_subtree_check,fsid=0,sec=sys,rw,secure,root_squash,no_all_squash)
/srv/nfs4/backups
                20.20.20.0/24(sync,wdelay,hide,no_subtree_check,sec=sys,ro,secure,root_squash,no_all_squash)
```

---

## Firewall config
```bash
ufw allow from 20.20.20.0/24 to any port nfs
```

---

## client config: installing the packages
```bash
apt install nfs-common
```

## mounting
```bash
sudo mount -t nfs -o vers=4 <NFS_SERVER_IP>:/backups /backups
```

## viewing all mount options
```bash
man nfs
```

---

## about permissions
In order for the users on the client machines to have access,
	NFS expects the client’s user and group ID’s to match with those on the server.
Another option is to use the **NFSv4 idmapping** feature that translates user and group IDs to names and the other way around.

## Security feature: Root squash
Root squash is the removal of root privileges of the user mounting the share.
*without root squashing,* the user connecting from the network can have root access.
It prevents root users connected from the clients from having root privileges on the mounted shares by mapping root `UID` and `GID` to `nobody`/`nogroup` `UID`/`GID`.

## How this can be exploited for privilege escalation
*if there's no root squashing:*
1. we can mount a NFS volume
2. copy a normal bash shell to the mount directory
4. setuid for the bash shell
5. connect to the NFS host using ssh
6. execute the SUID bash shell with the `-p` flag to preserve permissions and gain root access

*This happens because the chmod +s bash was done as root in the mount directory and was percieved by the system as done by its own root account*

## getting nfs shell to work
1. get the binary from the repo
2. link existing libreadline shared objects for the tool to work
`ln -s /usr/lib/x86_64-linux-gnu/libreadline.so.8 /usr/lib/x86_64-linux-gnu/libreadline.so.7`

## `nfsshell` usage
```
# selecting the target
host <TARGET_IP>
# showing all exported file systems
export
# mounting
mount <OPTIONS> <PATH>
# setting uid and gid
uid <TARGET_USER_UID> [<SECRET_KEY>]
gid <TARGET_USER_GID>
```